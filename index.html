<html>
  <head>
    <link rel="stylesheet" href="style.css">
  </head>

  <body style="background-color: lightgrey; text-align: center;">
    <h1>budget slay the spire</h1>
  </body>

  <div>
    <table id="enemies" class="center">
      <!--<tb> <button>
        slime <br>
        <img src="https://image.similarpng.com/file/similarpng/original-picture/2020/07/monster-character-Hand-drawn-on-transparent-background-PNG.png" alt="enemy" style="width: 100px; height: 100px; float: right;"> <br>
        10/10 hp <br>
      </button> </tb>-->
    </table>
  </div>

  <body>
    <table id="allies" class="center">
      <!--<tb> <button>
        player <br> 
        <img src="https://cdn2.iconfinder.com/data/icons/knight-templar-at-war/253/knight-004-512.png" alt="player" style="width: 100px; height: 100px; float: left;"> <br>
        25/25 health <br>
      </button> </tb>-->
    </table>
  </body>
  
  <body>
    <table id="hand" class="center">
      <!--<td><button> 
        slash <br>
        <img src="https://www.seekpng.com/png/detail/29-299682_black-sword-png.png" style="width: 50px; height: 50px;"> <br>
        deal 4 dmg <br>
      </button></td>-->
    </table>
  </body>

  <body>
    <button id="endTurn"> end turn </button>
  </body>

  <div>
    <p id="log"></p>
  </div>

  <script>
    const cEnemies = document.getElementById("enemies");
    const cAllies = document.getElementById("allies");
    const cHand = document.getElementById("hand");
    const log = document.getElementById("log");
    const endTurn = document.getElementById("endTurn");

    var cEnemiesA = [];
    var cAlliesA = [];

    var searching = -1;
    var selectedD = 0;

    function makeCopy(object, type) {
      if (type == "unit") {
        newObject = new Unit();
      } else if (type == "card") {
        newObject = new Card();
      }

      Object.assign(newObject, object);
      return newObject;
    }

    function addLog(text) {
      if (log.offsetHeight/parseInt(log.style.lineHeight) >= 10) {
        log.textContent.split("\n").slice(1).join("\n");
      }
      log.textContent += text + "\n";
    }
    
    class Unit {
      name = "def";
      image = "";
      health = 5;
      shield = 0;
      deck = [];
      energy = 1;
      
      constructor(name, health, shield, energy, deck, image) {
        this.name = name;
        this.image = image;
        this.health = health;
        this.shield = shield;
        this.deck = deck;
        this.energy = energy;
      }

      damageUnit(damage) {
        if (shield > 0) {
          if (damage > shield) {
            shield = 0;
            health -= damage - shield;
          } else {
            shield -= damage;
          }
        } else {
          health -= damage;
        }
      }
    }

    class Deck {  
      constructor(cards) {
        this.draw = cards;
        this.discard = [];
        this.hand = [];
      }

      drawCard(amount) {
        while (amount > 0) {
          if (draw.length == 0) {
            reshuffle();
          }
          drawn = Math.random() * draw.length;
          hand.push(draw[drawn]);
          draw.splice(drawn, 1);
          amount--;
        }
      }

      reshuffle() {
        draw = [...discard];
        discard = [];
      }
    }

    class Card {
      name = "test";
      desc = "";
      image = "";
      target = "foe"; 
      cost = 0;
      
      constructor(name, desc, cost, action, val, image) {
        this.name = name;
        this.desc = desc;
        this.image = image;
        this.cost = cost; 
        this.action = action; //dmg, shi
        this.val = val;
      }

      findTarget(index) { //current card, expects only player use
        searching = index;
        addLog("use on who?");
      }

      static playerAction(array, index) { //array and index of target, assumes player play
        target = array[index];
        
        if (searching != -1) {
          if (searching == -1) {
            addLog("no card to play"); 
          } else if (target == this) {
            addLog("cancelled");
          } else {
            card = cHandA[searching];
            if (action == "dmg" && array == cEnemies) {
              target.damageUnit(card.val);
              addLog(target.name + " took " + card.val.toString() + "damage");
            } else if (action == "shi" && array == cAllies) {
              target.shield += card.val;
              addLog(target.name + " gained " + card.val.toString() + "shield");
            } else {
              addLog("wrong target");
            }
          } 

          cHand.splice(searching, 1); //sync with unit hand
          Update.removeB("card", cHand);
          searching = -1;
          Update.stats();
        } 
      }

      botAction(array, index, deck) { //assumes bot play
          target = array[index];
        
          if (action == "dmg") {
            target.damageUnit(val);
            addLog(target.name + " took " + val.toString() + "damage");
          } else if (action == "shi") {
            target.shield += val;
            addLog(target.name + " gained " + val.toString() + "shield");
          }

          deck.hand.splice();
          Update.stats();
      }
    }

    class Update {
      static makeUnitB(array, index) {
        const unit = array[index];
        const newButton = document.createElement("button");
        const stats = document.createTextNode(unit.name + "\n" + unit.health + "(" + unit.shield + ")\n");
        const img = document.createElement("img");
        img.src = unit.image;
        const tbItem = document.createElement("tb"); 
        tbItem.id = index;
        
        newButton.appendChild(name);
        newButton.appendChild(document.createElement("br"));
        newButton.appendChild(img);
        newButton.appendChild(document.createElement("br"));
        newButton.appendChild(stats);
        
        newButton.addEventListener("click", function() {
          Card.doAction(array, index, "player");
        });

        tbItem.appendChild(newButton);

        if (array == cEnemiesA) {
          cEnemies.appendChild(tbItem);
        } else {
          cAllies.appendChild(tbItem);
        }
        
      }

      static makeCardB(array, index) {
        const card = array[index];
        const newButton = document.createElement("button");
        const stats = document.createTextNode(card.energy + "  " + card.name + "\n" + card.desc + "\n");
        const img = document.createElement("img");
        img.src = card.image;
        const tbItem = document.createElement("tb"); 
        tbItem.id = index;
        
        newButton.appendChild(name);
        newButton.appendChild(document.createElement("br"));
        newButton.appendChild(img);
        newButton.appendChild(document.createElement("br"));
        newButton.appendChild(stats);

        newButton.addEventListener("click", function() {
          card.findTarget(array, index);
        });

        tbItem.appendChild(newButton);

        if (array == cEnemiesA) {
          cEnemies.appendChild(tbItem);
        } else {
          cAllies.appendChild(tbItem);
        }
      }

      static stats() {
        for (let i = 0; i < cAlliesA.length; i++) {
          var unitTB = cAllies.tBodies[i];
          var unitB = unitTB.firstChild;
          var unit = cAlliesA[i];
          unitB.textContent = unit.name + "\n" + unit.health + "(" + unit.shield + ")\n";
          unitTB.id = i;
        }

        for (let i = 0; i < cEnemiesA.length; i) {
          var unitTB = cEnemies.tBodies[i];
          var unitB = unitTB.firstChild;
          var unit = cEnemiesA[i];
          unitB.textContent = unit.name + "\n" + unit.health + "(" + unit.shield + ")\n";
          unitTB.id = i;
        }

        var deck = cAlliesA[selectedD].deck;
        for (let i = 0; i < deck.length; i++) {
          var cardTB = cHand.tBodies[i]; 
          var cardB = cardTB.firstChild;
          var card = deck[i];
          cardB.textContent = card.energy + "  " + card.name + "\n" + card.desc + "\n";
          cardTB.id = i;
        }
      }

      //static changeHands() change viewed hand between allies

      static removeB(target, index) {
        if (target == "ally") {
          var table = cAllies;
        } else if (target == "enemy") {
          var table = cEnemies;
        } else if (target == "card") {
          var table = cHand;
        }
        
        table.tBodies[index].remove();
      }
    }

    class GameManager {
      static startFight() {
        var numEnemies = 1;

        for (let i = 0; i < numEnemies; i++) {
          var enemy = Math.random() * enemies.length;
          cEnemiesA.push(...enemies[enemy]);
          Update.makeUnitB(cEnemiesA, i);
        }

      }

      static endTurn() {
        for (let i = 0; i < cEnemiesA.length; i++) {
          var enemy = cEnemiesA[i];
          var energy = enemy.energy;
          var canPlay = true;
          var deck = enemy.Deck;
          var index = 0;
          var drawCount = 2;

          deck.drawCard(drawCount);
          
          while (canPlay && deck.hand.length > 0) {
            deck.hand[index];
          }
        }
      }

      static startTurn() {
        deck.drawCard(drawCount);
        
      }

      //static tickStatus() tick all statuses
    }

    const cards = [
      slash = new Card("slash", "deal 5 damage", 1, "dmg", "5", ""),
      slime = new Card("slime", "deal 3 damage", 1, "dmg", "3", ""),
      block = new Card("block", "give 5 shield", 1, "shi", "5", "")
    ];
    const enemies = [
      slime = new Unit("slime", 10, 0, 1, new Deck(cards[1], cards[1]), "")
      
    ];
    const allies = [
      knight = new Unit("knight", 25, 0, 3, new Deck(cards[0], cards[0]), "")
    ];

    addLog("click end turn button to start");
    endTurn.addEventListener("click", function() {
      if (cAlliesA.length == 0) {
        cAlliesA.push(...allies[0]);
        Update.makeUnitB(cAlliesA, 0);
        GameManager.startFight();
      } else {
        GameManager.endTurn();
      }
    });
  </script>
</html>
